{"version":3,"sources":["rest.js"],"names":["tmpl","$","ajaxSetup","cache","dataType","updateQueryStringParameter","uri","key","value","re","RegExp","separator","indexOf","match","replace","getCookie","name","cookieValue","document","cookie","cookies","split","i","length","jQuery","trim","substring","decodeURIComponent","csrftoken","csrfSafeMethod","method","test","beforeSend","xhr","settings","type","crossDomain","setRequestHeader","JSON_TYPE","STATUSES","paramerror","unauthorized","forbidden","notfound","ok","servererror","API","url","params","extend","contentType","_$container","prototype","param","newObj","isPlainObject","json","formdata","undefined","currentUrl","each","currentParamString","_toggleMask","find","toggle","_request","payload","JSON","stringify","_processResponse","ajax","data","isArray","results","always","container","el","renderBefore","response","codes","callbacks","Callbacks","add","cb","status","fire","responseJSON","_"],"mappings":"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","file":"../../util/rest.js","sourcesContent":["import 'jquery'\nimport * as tmpl from 'util/tmpl'\n\n$.ajaxSetup({\n    cache: false,\n    dataType: 'json'\n})\n\n// Helper Functions\n\nfunction updateQueryStringParameter (uri, key, value) {\n    let re = new RegExp(`([?&])${key}=.*?(&|$|#)`, \"i\")\n    let separator = uri.indexOf('?') !== -1 ? \"&\" : \"?\"\n    return (uri.match(re)) ? uri.replace(re, `$1${key}=${value}$2`) : `${uri}${separator}${key}=${value}`\n}\n\n// Setup CSRF Token\n\nfunction getCookie (name) {\n    let cookieValue = null;\n    if (document.cookie && document.cookie !== '') {\n        let cookies = document.cookie.split(';')\n        for (let i = 0; i < cookies.length; i++) {\n            let cookie = jQuery.trim(cookies[i])\n            // Does this cookie string begin with the name we want?\n            if (cookie.substring(0, name.length + 1) === (name + '=')) {\n                cookieValue = decodeURIComponent(cookie.substring(name.length + 1))\n                break\n            }\n        }\n    }\n    return cookieValue\n}\nlet csrftoken = getCookie('csrftoken')\n\nfunction csrfSafeMethod(method) {\n    // these HTTP methods do not require CSRF protection\n    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method))\n}\n\n$.ajaxSetup({\n    beforeSend: function (xhr, settings) {\n        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {\n            xhr.setRequestHeader(\"X-CSRFToken\", csrftoken)\n        }\n    }\n})\n\n// `API` Definition\n\nconst JSON_TYPE = 'application/json'\nconst STATUSES = {\n    paramerror: [400],\n    unauthorized: [401],\n    forbidden: [403],\n    notfound: [404],\n    ok: [200, 201, 204],\n    servererror: [500]\n}\nfunction API (url) {\n    if (url instanceof API) {\n        this.url = url.url\n        this.params = $.extend({}, url.params)\n        this.contentType = url.contentType\n        this._$container = url._$container\n    } else {\n        this.url = url\n        this.params = {}\n        this.contentType = JSON_TYPE\n    }\n}\nAPI.prototype = {\n\n    param (name, value) {\n        let newObj = new API(this)\n\n        if ($.isPlainObject(name))\n            $.extend(newObj.params, name)\n        else\n            newObj.params[name] = value\n\n        return newObj\n    },\n    json () {\n        this.contentType = JSON_TYPE\n    },\n    formdata () {\n        this.contentType = undefined\n    },\n    currentUrl () {\n        let url = this.url\n        $.each(this.params, (key, value) =>\n            url = updateQueryStringParameter(url, key, value)\n        )\n        return url\n    },\n    currentParamString () {\n        let url = this.currentUrl()\n        return (url.split('?')[1] || '')\n    },\n    _toggleMask (value) {\n        if (this._$container)\n            this._$container.find('.mask').toggle(value)\n    },\n    _request (method, payload) {\n        if (this.contentType === JSON_TYPE)\n            payload = JSON.stringify(payload)\n\n        $.each(this.params, (key, value) =>\n            this.url = updateQueryStringParameter(this.url, key, value)\n        )\n\n        this._toggleMask(true)\n\n        return this._processResponse($.ajax({\n            url: this.url,\n            type: method,\n            contentType: this.contentType,\n            data: payload\n        })).ok(data => {\n            if (!this._$container) return\n            if ($.isArray(data.results)) {\n                this._$container.find('.empty-placeholder').toggle(!data.results.length)\n            }\n        }).always(() => {\n            this._toggleMask(false)\n        })\n    },\n    container (el) {\n        let newObj = new API(this)\n        newObj._$container = $(el)\n        tmpl.renderBefore(newObj._$container, 'empty', {})\n        tmpl.renderBefore(newObj._$container, 'mask', {})\n        return newObj\n    },\n    _processResponse (response) {\n        $.each(STATUSES, (name, codes) => {\n            let callbacks = $.Callbacks()\n            // bind shortcuts to response\n            response[name] = cb => {\n                callbacks.add(cb)\n                return response\n            }\n            // fire callbacks according to status code\n            response.always(() => {\n                if (codes.indexOf(response.status) >= 0) {\n                    callbacks.fire(response.responseJSON || {}, response)\n                }\n            })\n        })\n\n        return response\n    }\n}\n\n$(['get', 'post', 'put', 'patch', 'delete']).each((_, name) =>\n    API.prototype[name] = function (payload) {\n        return this._request(name, payload)\n    }\n)\n\nexport default API\n"]}