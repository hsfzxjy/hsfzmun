{"version":3,"sources":["index.js"],"names":["tmpl","verbatim","$sidebar","$","$chatview","$textarea","$title","$cover","$submitButton","$loadHistoryButton","$messagePane","$chatList","$searchInput","$searchPane","$messageNotifier","on","prop","val","fadeIn","reg","RegExp","find","each","$this","pinyin","data","toggle","test","click","target","is","closest","length","fadeOut","scrollToBottom","scrollTop","scrollHeight","isBottomed","height","$messageBox","outerHeight","scroll","trigger","showNotifier","message","is_me","manager","isCurrentSessionName","session_name","html","digest","show","hideNotifier","hide","activate","_sessions","clearInput","change","$form","remove","form","payload","uid","$controlButton","uploader","$button","$progress","icons","submit","abortAll","type","$i","iconBaseName","toggleClass","toggleView","showView","argSide","undefined","argChat","USER_SESSION","GROUP_SESSION","Session","object","_type","_object","_entries","_messages","_historyAPI","param","_earliestTime","_unreadCount","prototype","_decorateMessage","sender","_users","filter","u","id","userId","direction","nickname","content","slice","replace","getLastTime","created","loadHistory","get","ok","results","next","forEach","unshift","isActive","renderHistory","messages","oldHeight","messageRenderer","renderMessages","reverse","BEFORE","addEntry","$el","push","extraFields","result","receiver","receivedMessage","renderMessage","AFTER","item","chatList","getItem","_incUnread","setUnread","unreadManager","inc","_clearUnread","dec","currentSession","title","clear","ChatListItem","session","_session","_init","_createElement","_$el","renderBefore","topElement","detach","prependTo","top","value","_chatItems","_names","_storeNames","name","window","localStorage","setObj","recover","getObj","renderEachSwitch","makeUserSessionName","ids","sort","join","makeGroupSessionName","g","_groups","_usersLoaded","_groupsLoaded","init","_loadUsers","_loadGroups","then","connect","_bindEventListeners","_bindSocketListeners","_loadUnreadMessages","receivedMessages","loading","start","removeClass","addClass","stop","bind","subscribe","submitted","open","_updateLastTime","time","setItem","Date","toISOString","setTimeout","getPayload","send","_loadContact","api","sessionName","store","$list","pipe","x","entries","getFullChars","toLowerCase","_createSession","entry","render","searchEntry","clone","appendTo","add","y","pyx","pyy","renderInto","_count","number","_syncState"],"mappings":"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","file":"../../chat/index.js","sourcesContent":["import 'bootstrap'\nimport 'jquery'\nimport API from 'util/rest'\nimport pinyin from 'util/pinyin'\nimport user from 'user-info'\nimport * as tmpl from 'util/tmpl'\nimport socket from 'util/websocket'\nimport Form from 'util/form'\nimport { Upload } from 'util/attachments'\n\nimport { throttle, randomString, wait } from 'util/common'\n\ntmpl.verbatim()\n\n// Global variables\n\nconst $sidebar = $('#sidebar'), $chatview = $('#chat-view')\nconst $textarea = $('#input-bar textarea')\nconst $title = $('div.top-bar .top-title')\nconst $cover = $('#chat-view div.cover')\nconst $submitButton = $('#input-bar button[type=submit]')\nconst $loadHistoryButton = $('#load-history')\nconst $messagePane = $('#message-pane')\nconst $chatList = $('#chat-pane ul')\nconst $searchInput = $('#search-box')\nconst $searchPane = $('#search-pane')\nconst $messageNotifier = $('#message-notifier')\n\n// Submit Button State\n\n$textarea.on('input change', () => $submitButton.prop('disabled', !$textarea.val()))\n\n// Search\n\n$searchInput.on('focus', () => {\n    $searchPane.fadeIn()\n}).on('input', () => {\n    let reg = new RegExp($searchInput.val())\n\n    $searchPane.find('li').each(function () {\n        let $this = $(this), pinyin = $this.data('py')\n\n        $this.toggle(reg.test(pinyin))\n    })\n})\n\n$('html').click(({ target }) => {\n    if ($searchPane.is(':visible') && !$(target).closest('#searchPane, #search-box').length) $searchPane.fadeOut()\n})\n\n// Scroll Utils\n\nfunction scrollToBottom () {\n    $messagePane.scrollTop($messagePane[0].scrollHeight)\n}\n\nfunction isBottomed () {\n    return $messagePane.scrollTop() + $messagePane.height() > $loadHistoryButton.height() + 10 + $messageBox.outerHeight()\n}\n\n$messagePane.scroll(throttle(() => {\n    if (isBottomed())\n        $messagePane.trigger('bottomed')\n}, 100))\n\n// Notifier Utils\n\nfunction showNotifier (message) {\n    if (!message.is_me && (!isBottomed() || manager.isCurrentSessionName(message.session_name)))\n        $messageNotifier.html(message.digest).data('session_name', message.session_name).show()\n}\n\nfunction hideNotifier (message) {\n    $messageNotifier.hide()\n}\n\n$messagePane.on('bottomed', () => {\n    if (manager.isCurrentSessionName($messageNotifier.data('session_name')))\n        $messageNotifier.hide()\n})\n\n$messageNotifier.click(() => {\n    manager.activate(manager._sessions[$messageNotifier.data('session_name')])\n    scrollToBottom()\n    hideNotifier()\n})\n\n// Util for Input Bar\n\nfunction clearInput () {\n    $textarea.val('').change()\n    $form.find('input[name=\"attachments[]\"]').remove()\n}\n\n// Input Form\n\nconst $form = $('#input-bar form')\n\nconst form = new Form($form, null, null).payload(data => data.uid = randomString())\n\n// Upload Attachments\n\nconst $controlButton = $('#upload-file-button .control-button')\n\nconst uploader = new Upload({\n    $button: '#upload-file-button',\n    $form,\n    $progress: '#input-bar .progress .progress-bar'\n}).on('start', () => {\n    $controlButton.show().find('i').icons('times')\n}).on('always', () => $controlButton.fadeOut())\n.on('uploaded', () => manager.submit())\n\n$controlButton.click(() => uploader.abortAll())\n\n// Top nav icons\n\n$('#sidebar ul.top-nav li a')\n    .on('shown.bs.tab hidden.bs.tab', function ({ type }) {\n        let $i = $(this).find('i'), iconBaseName = `fa-${$i.data('icon')}`\n        $i\n            .toggleClass(iconBaseName, type === 'shown')\n            .toggleClass(`${iconBaseName}-o`, type === 'hidden')\n    })\n\n// sidebar & chat-view toggler\n\nfunction toggleView (showView) {\n    let argSide = showView === undefined ? undefined : showView, argChat = showView === undefined ? undefined : !showView\n    $sidebar.toggleClass('hidden-sm-down', argSide)\n    $chatview.toggleClass('hidden-sm-down', argChat)\n}\n\n$('body').on('click', '.toggle-view', toggleView)\n\n// Session Class Definition\n\nconst USER_SESSION = 'user', GROUP_SESSION = 'group'\n\nfunction Session (type, object) {\n    this.session_name = object.session_name\n    this._type = type\n    this._object = object\n    this._entries = []\n    this._messages = []\n    this._historyAPI = new API('/api/messages/history/')\n        .param('session_name', object.session_name)\n        .param('before', this._earliestTime())\n    this._unreadCount = 0\n}\n\nSession.prototype = {\n\n    _decorateMessage (message) {\n        message.sender = manager._users.filter(u => u.id === message.sender)[0]\n        message.is_me = message.sender.id === user.userId\n        message.direction = message.is_me ? 'right' : 'left'\n        message.digest = (message.is_me ? '' : `${message.sender.nickname}: `) + message.content.slice(0, 20).replace(/\\s/g, '')\n    },\n\n    _earliestTime () {\n        if (!this._messages.length) return manager.getLastTime()\n        return this._messages[0].created\n    },\n\n    loadHistory () {\n        if (!this._historyAPI) return\n        new API(this._historyAPI).get()\n            .ok(({ results, next }) => {\n                results.forEach(message => {\n                    this._decorateMessage(message)\n                    this._messages.unshift(message)\n                })\n\n                if (this.isActive()) this.renderHistory(results)\n\n                this._historyAPI = next\n                if (!next) $loadHistoryButton.hide()\n            })\n    },\n\n    renderHistory (messages) {\n        let oldHeight = $messageBox.height()\n        messageRenderer.renderMessages(messages.reverse(), tmpl.BEFORE)\n        $messagePane.scrollTop($messageBox.height() - oldHeight)\n    },\n\n    addEntry ($el) {\n        this._entries.push($el)\n\n        $el.click(() => manager.activate(this))\n    },\n\n    extraFields () {\n        let result = { session_name: this._object.session_name }\n\n        if (this._type === USER_SESSION) result.receiver = this._object.id\n\n        return result\n    },\n\n    receivedMessage (message) {\n        this._decorateMessage(message)\n        this._messages.push(message)\n        if (this.isActive()) messageRenderer.renderMessage(message, tmpl.AFTER)\n        let item = chatList.getItem(this)\n        item.receivedMessage(message)\n        if (!this.isActive()) {\n            this._incUnread()\n            item.setUnread(true)\n        }\n        showNotifier(message)\n    },\n\n    _incUnread () {\n        this._unreadCount++\n        unreadManager.inc(1)\n    },\n\n    _clearUnread () {\n        unreadManager.dec(this._unreadCount)\n        this._unreadCount = 0\n    },\n\n    isActive () {\n        return this === manager.currentSession\n    },\n\n    activate () {\n        $title.html(this._object.title)\n        messageRenderer.clear()\n        messageRenderer.renderMessages(this._messages, tmpl.AFTER)\n        $messagePane.scrollTop($messageBox.height())\n        let item = chatList.getItem(this)\n        if (this._historyAPI) $loadHistoryButton.show()\n        this._clearUnread()\n        item.setUnread(false)\n    }\n}\n\n// ChatListItem Class Definition\n\nfunction ChatListItem (session) {\n    this._session = session\n    this._init()\n}\n\nChatListItem.prototype = {\n\n    _init () {\n        this._createElement()\n    },\n\n    _createElement () {\n        this._$el = tmpl.renderBefore($chatList, 'chat', this._session._object)\n        this._session.addEntry(this._$el)\n    },\n\n    topElement () {\n        this._$el.detach().prependTo($chatList)\n    },\n\n    receivedMessage (message) {\n        chatList.top(this._session)\n        this._$el.find('.message-digest').html(message.digest)\n    },\n\n    setUnread (value) {\n        this._$el.find('.dot').toggle(value)\n    }\n}\n\n// chatList Object Definition\n\nconst chatList = {\n\n    _chatItems: {},\n    _names: [],\n\n    getItem (session) {\n        let item = this._chatItems[session.session_name]\n\n        if (item !== undefined) return item\n        item = this._chatItems[session.session_name] = new ChatListItem(session)\n        this._names.unshift(session.session_name)\n        this._storeNames()\n        return item\n    },\n\n    top (session) {\n        let item = this.getItem(session), name = session.session_name\n\n        item.topElement()\n        this._names.remove(name).unshift(name)\n        this._storeNames()\n    },\n\n    _storeNames () {\n        window.localStorage.setObj('chat-items', this._names)\n    },\n\n    recover () {\n        this._names = window.localStorage.getObj('chat-items') || []\n\n        this._names.slice().reverse().forEach(session_name => {\n            if (manager._sessions[session_name])\n                this.getItem(manager._sessions[session_name])\n        })\n    }\n}\n\n\n// messageRenderer Object Definition\n\nconst $messageBox = $('#message-box')\n\nconst messageRenderer = {\n\n    clear () {\n        $messageBox.html('')\n    },\n\n    renderMessages (messages, direction) {\n        tmpl.renderEachSwitch(direction, $messageBox, 'message', messages)\n    },\n\n    renderMessage (message, direction) {\n        this.renderMessages([message], direction)\n    }\n}\n\n// manager Object Definition\n\nconst makeUserSessionName = u => {\n    let ids = [user.userId, u.id]\n    ids.sort()\n    return `user_${ids.join('_')}`\n}\nconst makeGroupSessionName = g => `discussion_${g.id}`\n\nconst manager = {\n\n    _users: [],\n    _groups: [],\n    _sessions: {},\n\n    _usersLoaded: false,\n    _groupsLoaded: false,\n\n    currentSession: null,\n\n    init () {\n        this._loadUsers()\n        this._loadGroups()\n\n        wait(() => this._groupsLoaded && this._usersLoaded).then(() => {\n            chatList.recover()\n            socket.connect()\n        })\n\n        this._bindEventListeners()\n        this._bindSocketListeners()\n    },\n\n    _loadUnreadMessages () {\n        new API('/api/messages/unread/').param('after', this.getLastTime()).get()\n            .ok(results => this.receivedMessages(results))\n    },\n\n    _bindEventListeners () {\n        $submitButton\n            .loading({\n                start: function () { this.find('i').removeClass('fa-send-o').addClass('fa-spin fa-circle-o-notch') },\n                stop: function () { this.find('i').removeClass('fa-spin fa-circle-o-notch').addClass('fa-send-o') }\n            })\n            .click(this.submit.bind(this))\n\n        $loadHistoryButton\n            .click(() => this.currentSession.loadHistory())\n    },\n\n    _bindSocketListeners () {\n        socket.subscribe('chat', message => {\n            if (message.uid === $submitButton.data('waiting-uid')) this.submitted()\n            this.receivedMessages([message])\n        }).open(() => this._loadUnreadMessages())\n    },\n\n    receivedMessages (messages) {\n        messages.forEach(this.receivedMessage.bind(this))\n    },\n\n    receivedMessage (message) {\n        this._updateLastTime(message.created)\n        this._sessions[message.session_name].receivedMessage(message)\n    },\n\n    _updateLastTime (time) {\n        window.localStorage.setItem('last-time', time)\n    },\n\n    getLastTime () {\n        return window.localStorage.getItem('last-time') || new Date().toISOString()\n    },\n\n    submitted () {\n        $submitButton.loading('stop')\n        clearInput()\n        setTimeout(() => scrollToBottom(), 150)\n    },\n\n    submit () {\n        let payload = form.getPayload()\n        $submitButton.loading('start').data('waiting-uid', payload.uid)\n        socket.send(payload)\n    },\n\n    _loadUsers () {\n        return this._loadContact({\n            api: '/api/users/',\n            sessionName: makeUserSessionName,\n            title: 'nickname',\n            store: '_users',\n            $list: '#user-contacts-pane ul',\n            type: USER_SESSION\n        }).ok(() => this._usersLoaded = true)\n    },\n\n    _loadContact ({ api, pipe = x => x, store, $list, type, title, sessionName }) {\n        return new API(api).get()\n            .ok(results => {\n                let entries = $()\n                this[store] = results\n\n                results.forEach(object => {\n                    pipe(object)\n                    object.title = object[title]\n                    object.pinyin = pinyin.getFullChars(object.title).toLowerCase()\n                    object.session_name = sessionName(object)\n\n                    let session = this._createSession(object, type)\n                    let entry = $(tmpl.render('contact', object))\n                    let searchEntry = entry.clone().appendTo($searchPane.find('ul'))\n\n                    session.addEntry(searchEntry)\n                    session.addEntry(entry)\n                    entries = entries.add(entry)\n                })\n\n                entries.sort((x, y) => {\n                    let pyx = '' + $(x).data('py'), pyy = '' + $(y).data('py')\n\n                    return pyx > pyy ? 1 : pyx === pyy ? 0 : -1\n                }).appendTo($list)\n            })\n    },\n\n    _createSession (object, type) {\n        let session = this._sessions[object.session_name]\n\n        if (session === undefined) {\n            session = this._sessions[object.session_name] = new Session(type, object)\n        }\n\n        return session\n    },\n\n    _loadGroups () {\n        return this._loadContact({\n            api: '/api/discussions/',\n            sessionName: makeGroupSessionName,\n            title: 'name',\n            store: '_groups',\n            $list: '#group-contacts-pane ul',\n            type: GROUP_SESSION\n        }).ok(() => this._groupsLoaded = true)\n    },\n\n    isCurrentSessionName (sessionName) {\n        return this.currentSession && this.currentSession.session_name === sessionName\n    },\n\n    activate (session) {\n        $cover.toggle(session === null)\n        if (this.currentSession === session) return\n        this.currentSession = session\n        if (this.currentSession === null) return\n\n        clearInput()\n        tmpl.renderInto('#input-bar div.extra-fields', 'extra-fields', session.extraFields())\n        session.activate()\n        toggleView(true)\n    }\n}\n\nmanager.init()\n\n// unreadManager Definition\n\nconst unreadManager = {\n\n    _count: 0,\n\n    inc (number) {\n        this._count += number\n        this._syncState()\n    },\n\n    dec (number) {\n        this._count -= number\n        this._syncState()\n    },\n\n    _syncState () {\n        if (this._count < 0) this._count = 0\n\n        $('.global.dot').toggle(this._count !== 0)\n    }\n}\n"]}